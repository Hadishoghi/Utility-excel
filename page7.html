<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù‚Ù„Ø§Ù… ØºÛŒØ± FIFO Ùˆ ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾</title>
    <style>
        body {
            font-family: Tahoma, Arial;
            background: #ffd700;
            margin: 20px;
            text-align: center;
        }

        .container {
            background: #ff69b4;
            border: 5px dashed #4b0082;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .upload-box {
            background: #98fb98;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .search-box {
            background: #87ceeb;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        th, td {
            border: 2px solid #4b0082;
            padding: 8px;
            text-align: center;
        }

        .red-row {
            background-color: #ff6b6b;
        }

        marquee {
            background: #4b0082;
            color: white;
            padding: 10px;
        }

        input[type="file"], input[type="text"] {
            padding: 10px;
            margin: 10px;
            border: 2px solid #4b0082;
        }

        button {
            background: #4b0082;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 3px solid #4b0082;
            width: 80%;
            max-width: 500px;
            text-align: center;
            border-radius: 10px;
            animation: modalopen 0.5s;
        }

        .close-btn {
            background: #ff4d4d; /* Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø² */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .close-btn:hover {
            background: #ff1a1a; /* Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡â€ŒØªØ± Ù‡Ù†Ú¯Ø§Ù… hover */
        }

        @keyframes modalopen {
            from {transform: scale(0)}
            to {transform: scale(1)}
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
</head>
<body>
    <div class="container">
        <marquee>ğŸŒŸ Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù‚Ù„Ø§Ù… ØºÛŒØ± FIFO Ùˆ ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾ ğŸŒŸ</marquee>
        
        <div class="upload-box">
            <h2>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</h2>
            <input type="file" id="excelFile" accept=".xlsx, .xls">
            <button onclick="processExcel()">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
        </div>

        <div class="upload-box">
            <h2>ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾</h2>
            <h3>Ù…Ø±Ø­Ù„Ù‡ Û±: ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø§ÙˆÙ„ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯</h3>
            <input type="file" id="file1" accept=".xlsx, .xls" onchange="handleFile1()">
            <h3>Ù…Ø±Ø­Ù„Ù‡ Û²: ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯ÙˆÙ… Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯</h3>
            <input type="file" id="file2" accept=".xlsx, .xls" onchange="handleFile2()">
            <h3>Ù…Ø±Ø­Ù„Ù‡ Û³: ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯</h3>
            <div>
                <label>Ø³ØªÙˆÙ† Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙØ§ÛŒÙ„ Ø§ÙˆÙ„:</label>
                <select id="lookupColumn1"></select>
            </div>
            <div>
                <label>Ø³ØªÙˆÙ† Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙØ§ÛŒÙ„ Ø¯ÙˆÙ…:</label>
                <select id="lookupColumn2"></select>
            </div>
            <div>
                <label>Ø³ØªÙˆÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø±Ú¯Ø´ØªÛŒ Ø§Ø² ÙØ§ÛŒÙ„ Ø¯ÙˆÙ…:</label>
                <select id="returnColumn"></select>
            </div>
            <div>
                <label>Ù†Ø§Ù… Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯:</label>
                <input type="text" id="newColumnName" placeholder="Ù†Ø§Ù… Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯">
            </div>
            <button onclick="processFiles()">Ø§Ù†Ø¬Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾ Ùˆ Ø§Ú©Ø³Ù¾ÙˆØ±Øª ÙØ§ÛŒÙ„</button>
        </div>

        <div class="search-box">
            <div>
                <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
                <input type="text" id="searchInput" placeholder="Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                <button onclick="searchItem()">Ø¬Ø³ØªØ¬Ùˆ</button>
            </div>
            <button class="export-btn" onclick="showExportModal()">ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„</button>
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>Ú©Ø¯ Ú©Ø§Ù„Ø§</th>
                    <th>Ø¨Ú†</th>
                    <th>ÙˆØ§Ø±Ø¯Ù‡</th>
                    <th>ØµØ§Ø¯Ø±Ù‡</th>
                    <th>Ù…Ø§Ù†Ø¯Ù‡</th>
                    <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§</th>
                    <th>Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="exportModal" class="modal">
            <div class="modal-content">
                <h3>ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h3>
                <button class="format-btn excel-btn" onclick="exportHighlightedToExcel()">Excel</button>
                <button class="format-btn pdf-btn" onclick="exportHighlightedToPDF()">PDF</button>
                <button class="close-btn" onclick="closeExportModal()">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let workbook1 = null;
        let workbook2 = null;
        let columns1 = [];
        let columns2 = [];
        let result = [];

        function handleFile1() {
            const file = document.getElementById('file1').files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                workbook1 = XLSX.read(data, {type: 'array'});

                const sheet = workbook1.Sheets[workbook1.SheetNames[0]];
                const data1 = XLSX.utils.sheet_to_json(sheet);
                if (data1.length > 0) {
                    columns1 = Object.keys(data1[0]);
                    updateColumnSelects();
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function handleFile2() {
            const file = document.getElementById('file2').files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                workbook2 = XLSX.read(data, {type: 'array'});

                const sheet = workbook2.Sheets[workbook2.SheetNames[0]];
                const data2 = XLSX.utils.sheet_to_json(sheet);
                if (data2.length > 0) {
                    columns2 = Object.keys(data2[0]);
                    updateColumnSelects();
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function updateColumnSelects() {
            const lookupSelect1 = document.getElementById('lookupColumn1');
            const lookupSelect2 = document.getElementById('lookupColumn2');
            const returnSelect = document.getElementById('returnColumn');

            if (!columns1.length || !columns2.length) return;

            lookupSelect1.style.display = 'block';
            lookupSelect2.style.display = 'block';
            returnSelect.style.display = 'block';

            lookupSelect1.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ØªÙˆÙ†</option>';
            columns1.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                lookupSelect1.appendChild(option);
            });

            lookupSelect2.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ØªÙˆÙ†</option>';
            returnSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ØªÙˆÙ†</option>';
            columns2.forEach(column => {
                const option1 = document.createElement('option');
                option1.value = column;
                option1.textContent = column;
                lookupSelect2.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = column;
                option2.textContent = column;
                returnSelect.appendChild(option2);
            });
        }

        function processFiles() {
            if (!workbook1 || !workbook2) {
                alert("Ù„Ø·ÙØ§ Ù‡Ø± Ø¯Ùˆ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø±Ø§ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯!");
                return;
            }

            const lookupColumn1 = document.getElementById('lookupColumn1').value;
            const lookupColumn2 = document.getElementById('lookupColumn2').value;
            const returnColumn = document.getElementById('returnColumn').value;
            const newColumnName = document.getElementById('newColumnName').value || 'Ù†ØªÛŒØ¬Ù‡_ÙˆÛŒÙ„ÙˆÚ©Ø§Ù¾';

            if (!lookupColumn1 || !lookupColumn2 || !returnColumn) {
                alert("Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!");
                return;
            }

            const sheet1 = workbook1.Sheets[workbook1.SheetNames[0]];
            const sheet2 = workbook2.Sheets[workbook2.SheetNames[0]];

            const data1 = XLSX.utils.sheet_to_json(sheet1);
            const data2 = XLSX.utils.sheet_to_json(sheet2);

            result = data1.map(row => {
                const lookupValue = row[lookupColumn1];
                const matchingRow = data2.find(r => r[lookupColumn2] === lookupValue);
                return {
                    ...row,
                    [newColumnName]: matchingRow ? matchingRow[returnColumn] : 'Ù†ØªÛŒØ¬Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯'
                };
            });

            exportToExcel(result);
        }

        function exportToExcel(result) {
            const ws = XLSX.utils.json_to_sheet(result);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Results");
            XLSX.writeFile(wb, "vlookup_result.xlsx");
        }

        function processExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                alert('Ù„Ø·ÙØ§ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                const range = XLSX.utils.decode_range(firstSheet['!ref']);
                const jsonData = [];

                for(let R = range.s.r + 1; R <= range.e.r; R++) {
                    const row = {};
                    
                    const itemCode = firstSheet[XLSX.utils.encode_cell({r: R, c: 0})];
                    const batch = firstSheet[XLSX.utils.encode_cell({r: R, c: 1})];
                    const input = firstSheet[XLSX.utils.encode_cell({r: R, c: 2})];
                    const output = firstSheet[XLSX.utils.encode_cell({r: R, c: 3})];
                    const remaining = firstSheet[XLSX.utils.encode_cell({r: R, c: 4})];
                    const description = firstSheet[XLSX.utils.encode_cell({r: R, c: 5})];
                    const supplier = firstSheet[XLSX.utils.encode_cell({r: R, c: 6})];

                    row['Ú©Ø¯ Ú©Ø§Ù„Ø§'] = itemCode ? itemCode.v : '';
                    row['Ø¨Ú†'] = batch ? batch.v : '';
                    row['ÙˆØ§Ø±Ø¯Ù‡'] = input ? input.v : 0;
                    row['ØµØ§Ø¯Ø±Ù‡'] = output ? output.v : 0;
                    row['Ù…Ø§Ù†Ø¯Ù‡'] = remaining ? remaining.v : 0;
                    row['Ø´Ø±Ø­ Ú©Ø§Ù„Ø§'] = description ? description.v : '';
                    row['Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡'] = supplier ? supplier.v : '';

                    jsonData.push(row);
                }

                globalData = jsonData.sort((a, b) => {
                    if (a['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString() === b['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString()) {
                        return parseFloat(b['Ø¨Ú†']) - parseFloat(a['Ø¨Ú†']);
                    }
                    return a['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString().localeCompare(b['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString());
                });

                displayData(globalData);
            };
            reader.readAsArrayBuffer(file);
        }

        function searchItem() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            if (!searchValue) {
                displayData(globalData);
                return;
            }

            const filteredData = globalData.filter(item => 
                Object.values(item).some(value => 
                    value.toString().toLowerCase().includes(searchValue)
                )
            );
            displayData(filteredData);
        }

        function displayData(data) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                const isNonFifo = checkNonFifo(data, row);
                if (isNonFifo) {
                    tr.classList.add('red-row');
                }

                tr.innerHTML = `
                    <td>${row['Ú©Ø¯ Ú©Ø§Ù„Ø§']}</td>
                    <td>${row['Ø¨Ú†']}</td>
                    <td>${row['ÙˆØ§Ø±Ø¯Ù‡']}</td>
                    <td>${row['ØµØ§Ø¯Ø±Ù‡']}</td>
                    <td>${row['Ù…Ø§Ù†Ø¯Ù‡']}</td>
                    <td>${row['Ø´Ø±Ø­ Ú©Ø§Ù„Ø§']}</td>
                    <td>${row['Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡']}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function checkNonFifo(data, currentRow) {
            if (!currentRow['ØµØ§Ø¯Ø±Ù‡']) return false;
            
            const sameCodeItems = data.filter(item => 
                item['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString() === currentRow['Ú©Ø¯ Ú©Ø§Ù„Ø§'].toString()
            );
            
            if (parseFloat(currentRow['ØµØ§Ø¯Ø±Ù‡']) > 0) {
                const currentIndex = sameCodeItems.findIndex(item => 
                    item['Ø¨Ú†'].toString() === currentRow['Ø¨Ú†'].toString()
                );
                
                for (let i = currentIndex + 1; i < sameCodeItems.length; i++) {
                    if (parseFloat(sameCodeItems[i]['Ù…Ø§Ù†Ø¯Ù‡']) > 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function getHighlightedRows() {
            const highlightedRows = [];
            const rows = document.querySelectorAll('#dataTable tbody tr.red-row');
            
            rows.forEach(row => {
                const rowData = {
                    'Ú©Ø¯ Ú©Ø§Ù„Ø§': row.cells[0].innerText,
                    'Ø¨Ú†': row.cells[1].innerText,
                    'ÙˆØ§Ø±Ø¯Ù‡': row.cells[2].innerText,
                    'ØµØ§Ø¯Ø±Ù‡': row.cells[3].innerText,
                    'Ù…Ø§Ù†Ø¯Ù‡': row.cells[4].innerText,
                    'Ø´Ø±Ø­ Ú©Ø§Ù„Ø§': row.cells[5].innerText,
                    'Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡': row.cells[6].innerText
                };
                highlightedRows.push(rowData);
            });

            return highlightedRows;
        }

        function exportHighlightedToExcel() {
            const highlightedRows = getHighlightedRows();
            if (highlightedRows.length === 0) {
                alert('Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(highlightedRows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Non-FIFO Items');
            XLSX.writeFile(workbook, 'Non-FIFO-Items.xlsx');
            closeExportModal();
        }

        function exportHighlightedToPDF() {
            const highlightedRows = getHighlightedRows();
            if (highlightedRows.length === 0) {
                alert('Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
                return;
            }

            pdfMake.fonts = {
                Tahoma: {
                    normal: 'https://cdn.jsdelivr.net/gh/rastikerdar/tahoma-font@v1.0.2/Tahoma.ttf',
                    bold: 'https://cdn.jsdelivr.net/gh/rastikerdar/tahoma-font@v1.0.2/Tahoma-Bold.ttf',
                }
            };

            const docDefinition = {
                content: [
                    { text: 'Ù„ÛŒØ³Øª Ø§Ù‚Ù„Ø§Ù… ØºÛŒØ± FIFO', style: 'header' },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
                            body: [
                                ['Ú©Ø¯ Ú©Ø§Ù„Ø§', 'Ø¨Ú†', 'ÙˆØ§Ø±Ø¯Ù‡', 'ØµØ§Ø¯Ø±Ù‡', 'Ù…Ø§Ù†Ø¯Ù‡', 'Ø´Ø±Ø­ Ú©Ø§Ù„Ø§', 'Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡'],
                                ...highlightedRows.map(row => [
                                    row['Ú©Ø¯ Ú©Ø§Ù„Ø§'],
                                    row['Ø¨Ú†'],
                                    row['ÙˆØ§Ø±Ø¯Ù‡'],
                                    row['ØµØ§Ø¯Ø±Ù‡'],
                                    row['Ù…Ø§Ù†Ø¯Ù‡'],
                                    row['Ø´Ø±Ø­ Ú©Ø§Ù„Ø§'],
                                    row['Ù†Ø§Ù… ØªØ§Ù…ÛŒÙ† Ú©Ù†Ù†Ø¯Ù‡']
                                ])
                            ]
                        }
                    }
                ],
                defaultStyle: {
                    font: 'Tahoma'
                },
                styles: {
                    header: {
                        fontSize: 18,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 0, 0, 10]
                    }
                }
            };

            pdfMake.createPdf(docDefinition).download('Non-FIFO-Items.pdf');
            closeExportModal();
        }

        function showExportModal() {
            const modal = document.getElementById('exportModal');
            modal.style.display = 'block';
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            modal.style.display = 'none';
        }
    </script>
</body>
</html>